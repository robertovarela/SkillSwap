@page "/Categories/Create"

@rendermode InteractiveServer
@attribute [Authorize]

@using Blazored.FluentValidation
@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Dtos.Category
@using RDS.Core.Libraries.Services

@inject ICategoryService Service
@inject NavigationManager NavigationManager

<title>@Title</title>

<AuthorizeView Roles="administrador">
    <Authorized>
        <MudContainer Class="mt-4" MaxWidth="MaxWidth.Medium">
            <!-- Header Section -->
            <div class="d-flex justify-space-between align-center mb-6">
                <div>
                    <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
                    <MudText Typo="Typo.body1" Class="text-secondary-theme">
                        Crie uma nova categoria para organizar os serviços da plataforma
                    </MudText>
                </div>
                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           Size="Size.Large"
                           StartIcon="Icons.Material.Filled.ArrowBack"
                           OnClick="@NavigateBack">
                    Voltar
                </MudButton>
            </div>

            <!-- Form Card -->
            <MudPaper Class="pa-6" Elevation="3">
                <EditForm Model="@_entity" OnValidSubmit="HandleValidSubmit" Context="editContext">
                    <FluentValidationValidator/>
                    <!-- Form Fields -->
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="Icons.Material.Filled.Edit" Class="mr-2"/>
                        Informações da Categoria
                    </MudText>

                    <MudGrid>
                        <!-- Nome Field -->
                        <MudItem xs="12">
                            <MudTextField T="string"
                                          @bind-Value="_entity.Name"
                                          Label="Nome da Categoria"
                                          Placeholder="Ex: Design Gráfico, Desenvolvimento Web..."
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="O nome da categoria é obrigatório"
                                          MaxLength="100"
                                          Counter="100"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="Icons.Material.Filled.Title"
                                          HelperText="Escolha um nome claro e descritivo"/>
                            <ValidationMessage For="@(() => _entity.Name)"/>
                        </MudItem>

                        <!-- Descrição Field -->
                        <MudItem xs="12" Class="mt-4">
                            <MudTextField T="string"
                                          @bind-Value="_entity.Description"
                                          Label="Descrição"
                                          Placeholder="Descreva o tipo de serviços que esta categoria engloba..."
                                          Variant="Variant.Outlined"
                                          Lines="4"
                                          MaxLength="500"
                                          Counter="500"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="Icons.Material.Filled.Description"
                                          HelperText="Uma boa descrição ajuda os usuários a entender melhor a categoria"/>
                            <ValidationMessage For="@(() => _entity.Description)"/>
                        </MudItem>
                    </MudGrid>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-space-between align-center mt-8">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   StartIcon="Icons.Material.Filled.Cancel"
                                   OnClick="@NavigateBack"
                                   Size="Size.Large">
                            Cancelar
                        </MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   ButtonType="ButtonType.Submit"
                                   StartIcon="Icons.Material.Filled.Save"
                                   Size="Size.Large"
                                   Disabled="@(_isSubmitting)">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Criar Categoria</span>
                            }
                        </MudButton>
                    </div>
                </EditForm>
            </MudPaper>

            <!-- Tips Card -->
            <!-- Tips Card -->
            <MudPaper Class="pa-4 mt-4" Elevation="1">
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    <MudIcon Icon="Icons.Material.Filled.Lightbulb" Color="Color.Warning" Class="mr-2"/>
                    Dicas para criar uma boa categoria
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                        <MudText Typo="Typo.body2">Use nomes claros e específicos</MudText>
                    </MudListItem>
                    <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                        <MudText Typo="Typo.body2">Inclua uma descrição detalhada do que a categoria engloba</MudText>
                    </MudListItem>
                    <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                        <MudText Typo="Typo.body2">Evite criar categorias muito similares às existentes</MudText>
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <AlertNotAdmin/>
    </NotAuthorized>
</AuthorizeView>

@code {
    private readonly CategoryCreateDto _entity = new();
    private const string Title = "Nova Categoria";
    private bool _isSubmitting;

    private async Task HandleValidSubmit()
    {
        try
        {
            _isSubmitting = true;
            await Service.AddAsync(_entity);
            NavigateBack();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao criar categoria: {ex.Message}");
            // Aqui você pode adicionar uma notificação de erro usando MudSnackbar se desejar
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"{AppRoutes.Categories}");
    }

}
