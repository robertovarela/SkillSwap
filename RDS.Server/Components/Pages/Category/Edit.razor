
@page "/Categories/Edit/{Id:long}"

@rendermode InteractiveServer
@attribute [Authorize]

@using Blazored.FluentValidation
@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Dtos.Category
@using RDS.Core.Libraries.Services

@inject ICategoryService Service
@inject NavigationManager NavigationManager

<title>@Title</title>

<AuthorizeView Roles="administrador">
    <Authorized>
        <MudContainer Class="mt-4" MaxWidth="MaxWidth.Medium">
            @if (_isLoading)
            {
                <!-- Loading State -->
                <div class="d-flex justify-center pa-8">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true"/>
                </div>
            }
            else if (_entity == null)
            {
                <!-- Not Found State -->
                <MudPaper Class="pa-8 text-center" Elevation="0">
                    <MudIcon Icon="Icons.Material.Outlined.Error"
                             Size="Size.Large"
                             Color="Color.Error"
                             Class="mb-4"/>
                    <MudText Typo="Typo.h6" Class="mb-2">
                        Categoria não encontrada
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mb-4 text-secondary-theme">
                        A categoria que você está tentando editar não existe ou foi removida.
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="Icons.Material.Filled.ArrowBack"
                               OnClick="@NavigateBack">
                        Voltar às Categorias
                    </MudButton>
                </MudPaper>
            }
            else
            {
                <!-- Header Section -->
                <div class="d-flex justify-space-between align-center mb-6">
                    <div>
                        <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
                        <MudText Typo="Typo.body1" Class="text-secondary-theme">
                            Atualize as informações da categoria selecionada
                        </MudText>
                    </div>
                    <MudButton Variant="Variant.Text"
                               Color="Color.Default"
                               Size="Size.Large"
                               StartIcon="Icons.Material.Filled.ArrowBack"
                               OnClick="@NavigateBack">
                        Voltar
                    </MudButton>
                </div>

                <!-- Form Card -->
                <MudPaper Class="pa-6" Elevation="3">
                    <EditForm Model="@_entity" OnValidSubmit="HandleValidSubmit" Context="editContext">
                        <FluentValidationValidator/>

                        <MudCard Class="mb-6" Elevation="1">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-start mb-3">
                                    <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                        <MudIcon Icon="Icons.Material.Filled.Category"/>
                                    </MudAvatar>
                                    <MudChip T="string"
                                             Text="@($"#{_entity.Id}")"
                                             Size="Size.Small"
                                             Variant="Variant.Text"
                                             Color="Color.Warning"/>
                                </div>

                                <MudText Typo="Typo.h6" Class="mb-2">
                                    @(string.IsNullOrWhiteSpace(_entity.Name) ? "Nome da categoria" : _entity.Name)
                                </MudText>

                                <MudText Typo="Typo.body2" Class="text-secondary-theme">
                                    @(string.IsNullOrWhiteSpace(_entity.Description) ? "Descrição da categoria aparecerá aqui..." : _entity.Description)
                                </MudText>
                            </MudCardContent>
                        </MudCard>

                        <!-- Form Fields -->
                        <MudText Typo="Typo.h6" Class="mb-4">
                            <MudIcon Icon="Icons.Material.Filled.Edit" Class="mr-2"/>
                            Informações da Categoria
                        </MudText>

                        <MudGrid>
                            <!-- Nome Field -->
                            <MudItem xs="12">
                                <MudTextField T="string"
                                              @bind-Value="_entity.Name"
                                              Label="Nome da Categoria"
                                              Placeholder="Ex: Design Gráfico, Desenvolvimento Web..."
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              RequiredError="O nome da categoria é obrigatório"
                                              MaxLength="100"
                                              Counter="100"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="Icons.Material.Filled.Title"
                                              Disabled="@_entity.HasAssociatedServices"
                                              HelperText="@(_entity.HasAssociatedServices ? "O nome não pode ser editado pois a categoria já possui serviços associados." : "Escolha um nome claro e descritivo")"/>
                                <ValidationMessage For="@(() => _entity.Name)"/>
                            </MudItem>

                            <MudText Typo="Typo.body2" Class="mb-4">
                                Conferir valor: @_entity.HasAssociatedServices
                            </MudText>

                            <!-- Descrição Field -->
                            <MudItem xs="12" Class="mt-4">
                                <MudTextField T="string"
                                              @bind-Value="_entity.Description"
                                              Label="Descrição"
                                              Placeholder="Descreva o tipo de serviços que esta categoria engloba..."
                                              Variant="Variant.Outlined"
                                              Lines="4"
                                              MaxLength="500"
                                              Counter="500"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="Icons.Material.Filled.Description"
                                              HelperText="Uma boa descrição ajuda os usuários a entender melhor a categoria"/>
                                <ValidationMessage For="@(() => _entity.Description)"/>
                            </MudItem>
                        </MudGrid>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-space-between align-center mt-8">
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Default"
                                       StartIcon="Icons.Material.Filled.Cancel"
                                       OnClick="@NavigateBack"
                                       Size="Size.Large">
                                Cancelar
                            </MudButton>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       ButtonType="ButtonType.Submit"
                                       StartIcon="Icons.Material.Filled.SaveAs"
                                       Size="Size.Large"
                                       Disabled="@(_isSubmitting)">
                                @if (_isSubmitting)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                                    <span>Salvando...</span>
                                }
                                else
                                {
                                    <span>Salvar Alterações</span>
                                }
                            </MudButton>
                        </div>
                    </EditForm>
                </MudPaper>

                <!-- Tips Card -->
                <MudPaper Class="pa-4 mt-4" Elevation="1">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="Icons.Material.Filled.Info" Color="Color.Info" Class="mr-2"/>
                        Informações sobre edição
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem T="string" Icon="Icons.Material.Filled.Warning" IconColor="Color.Warning">
                            <MudText Typo="Typo.body2">Alterar o nome pode afetar a organização existente</MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                            <MudText Typo="Typo.body2">As mudanças serão aplicadas imediatamente após salvar</MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="Icons.Material.Filled.Check" IconColor="Color.Success">
                            <MudText Typo="Typo.body2">Todos os serviços vinculados continuarão associados</MudText>
                        </MudListItem>
                    </MudList>
                </MudPaper>
            }
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <AlertNotAdmin/>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public long Id { get; set; }

    private CategoryUpdateDto? _entity;
    private const string Title = "Editar Categoria";
    private bool _isLoading = true;
    private bool _isSubmitting;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCategoryAsync();
        }
    }

    private async Task LoadCategoryAsync()
    {
        try
        {
            _isLoading = true;
            var result = await Service.GetForEditAsync(Id);
            _entity = result;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar categoria: {ex.Message}");
            _entity = null;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (_entity == null) return;

        try
        {
            _isSubmitting = true;
            await Service.UpdateAsync(_entity);
            NavigateBack();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao atualizar categoria: {ex.Message}");
            // Aqui você pode adicionar uma notificação de erro usando MudSnackbar se desejar
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"{AppRoutes.Categories}");
    }
}
