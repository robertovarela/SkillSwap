@*
@page "/Messages/Answer/{Id:long}"
*@

@rendermode InteractiveServer
@attribute [Authorize]

@using Blazored.FluentValidation
@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Dtos.Message
@using RDS.Core.Libraries.Services

@inject IUserContextService UserContext
@inject IMessageService MessageService
@inject NavigationManager NavigationManager
@inject UserTimeZoneService UserTimeZoneService
@inject ISnackbar Snackbar

<title>@Title</title>

<MudContainer Class="mt-4" MaxWidth="MaxWidth.Medium">
    <!-- Header Section -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
            <MudText Typo="Typo.body1" Class="text-secondary-theme">
                Leia a mensagem e envie sua resposta
            </MudText>
        </div>
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   Size="Size.Large"
                   StartIcon="Icons.Material.Filled.ArrowBack"
                   OnClick="@NavigateBack">
            Voltar
        </MudButton>
    </div>

    <AlertDefault
        ShowProfessionalNotFoundAlert="_showProfessionalNotFoundAlert"
        ShowCurrentUserNotFoundAlert="_showCurrentUserNotFoundAlert"
        NavigateToInstructions="UserContext.NavigateToInstructions"
        NavigateToLogin="UserContext.NavigateToLogin"
    />

    @if (_showContent)
    {
        @if (_isLoading)
        {
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true"/>
            </div>
        }
        else
        {
            <!-- Original Message Card -->
            <MudCard Class="mb-6" Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <div class="d-flex align-center">
                            <MudAvatar Color="Color.Primary" Class="mr-3">
                                <MudIcon Icon="Icons.Material.Filled.Person"/>
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.body1"><strong>@_message.SenderProfessionalName</strong></MudText>
                                <MudText Typo="Typo.caption" Class="text-secondary-theme">
                                    Enviado em: @UserTimeZoneService.ConvertToUserTimeZone(_message.SentAt).ToString("dd/MM/yyyy 'às' HH:mm")
                                </MudText>
                            </div>
                        </div>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_message.Content</MudText>
                </MudCardContent>
            </MudCard>

            <!-- Response Form Card -->
            <MudPaper Class="pa-6" Elevation="3">
                <EditForm @ref="_form" Model="@_messageCreateDto" OnValidSubmit="@HandleValidSubmit" Context="editContext">
                    <FluentValidationValidator/>
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="Icons.Material.Filled.Reply" Class="mr-2"/>
                        Sua Resposta
                    </MudText>

                    <MudTextField @ref="_responseTextField"
                                  T="string"
                                  @bind-Value="_messageCreateDto.Content"
                                  Label="Resposta"
                                  Placeholder="Escreva sua resposta aqui..."
                                  Variant="Variant.Outlined"
                                  Lines="5"
                                  Required="true"
                                  RequiredError="O conteúdo da resposta é obrigatório."
                                  MaxLength="1000"
                                  Counter="1000"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="Icons.Material.Filled.Message"
                                  HelperText="Escreva uma resposta clara e objetiva."/>
                    <ValidationMessage For="@(() => _messageCreateDto.Content)"/>

                    <div class="d-flex justify-space-between align-center mt-8">
                        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@NavigateBack" Size="Size.Large" StartIcon="Icons.Material.Filled.Cancel">Cancelar</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit" Size="Size.Large" StartIcon="Icons.Material.Filled.Send" Disabled="@(_isSubmitting || string.IsNullOrWhiteSpace(_messageCreateDto.Content))">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                                <span>Enviando...</span>
                            }
                            else
                            {
                                <span>Enviar Resposta</span>
                            }
                        </MudButton>
                    </div>
                </EditForm>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    private long _userId;
    private bool _showContent;
    private bool _showProfessionalNotFoundAlert;
    private bool _showCurrentUserNotFoundAlert;
    private bool _isLoading = true;
    private bool _isSubmitting;

    [Parameter] public long Id { get; set; }

    private MessageDto _message = new();
    private readonly MessageCreateDto _messageCreateDto = new();
    private const string Title = "Responder Mensagem";

    private EditForm? _form;
    private MudTextField<string> _responseTextField = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DefaultInitializationAsync();
            await LoadDataAsync();
            await UpdateMessageAsReadAsync();
            _isLoading = false;
            StateHasChanged();
            await _responseTextField.FocusAsync();
        }
    }

    private async Task DefaultInitializationAsync()
    {
        var context = await UserContext.InitializeUserContextAsync();
        _userId = context.UserId;
        _showCurrentUserNotFoundAlert = context.ShowCurrentUserNotFoundAlert;
        _showProfessionalNotFoundAlert = context.ShowProfessionalNotFoundAlert;
        _showContent = context.ShowContent;
    }

    private async Task LoadDataAsync()
    {
        var result = await MessageService.GetByIdAsync(Id, _userId);
        if (result != null)
        {
            _message = result;

            // Prepara a DTO para a resposta
            _messageCreateDto.SenderId = _userId;
            // --- INÍCIO DA LÓGICA CORRIGIDA ---

            // VERIFICAÇÃO: Quem é o destinatário da resposta?
            // Se o usuário atual for o remetente da mensagem original,
            // a resposta deve ser direcionada para o destinatário original.
            // Caso contrário, a resposta é para o remetente (comportamento padrão).
            if (_message.SenderId == _userId)
            {
                // Estou "respondendo" a uma mensagem que EU enviei.
                // A resposta deve ir para o destinatário daquela mensagem.
                _messageCreateDto.ReceiverId = _message.ReceiverId;
            }
            else
            {
                // Estou respondendo a uma mensagem que recebi.
                // A resposta deve ir para quem me enviou.
                _messageCreateDto.ReceiverId = _message.SenderId;
            }
        }
        else
        {
            Snackbar.Add("Mensagem não encontrada ou você não tem permissão para visualizá-la.", Severity.Warning);
            NavigationManager.NavigateTo(AppRoutes.Messages);
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            _isSubmitting = true;
            await MessageService.AddAsync(_messageCreateDto);
            Snackbar.Add("Resposta enviada com sucesso!", Severity.Success);
            NavigateBack();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao enviar resposta: {ex.Message}");
            Snackbar.Add("Ocorreu um erro ao enviar a resposta.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task UpdateMessageAsReadAsync()
    {
        // Marca a mensagem como lida apenas se o destinatário for o usuário atual e ela não estiver lida
        if (_message.ReceiverId == _userId && !_message.IsRead)
        {
            try
            {
                var updateDto = new MessageUpdateDto { Id = _message.Id, IsRead = true };
                await MessageService.UpdateAsync(updateDto);
                _message.IsRead = true; // Atualiza o estado local
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erro ao marcar mensagem como lida: {ex.Message}");
                // Não notifica o usuário, pois é uma operação de fundo
            }
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(AppRoutes.Messages);
    }
}