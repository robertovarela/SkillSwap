@*
@page "/Messages"
*@
@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Dtos.Message
@using RDS.Core.Dtos.ProfessionalProfile
@using RDS.Core.Libraries.Services
@using RDS.Core.Requests
@using RDS.Core.Utils

@rendermode InteractiveServer
@attribute [Authorize]

@inject IJSRuntime Js
@inject IUserContextService UserContext
@inject UserTimeZoneService UserTimeZoneService
@inject IProfessionalProfileService ProfessionalProfileService
@inject NavigationManager NavigationManager
@inject IMessageService MessageService
@implements IDisposable

<title>@Title</title>

<MudContainer Class="mt-4" MaxWidth="MaxWidth.ExtraLarge">
    <!-- Header Section -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
            <MudText Typo="Typo.body1" Class="text-secondary-theme">
                Gerencie suas conversas e mensagens com outros profissionais
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   StartIcon="Icons.Material.Filled.Add"
                   OnClick="@CreateEntity">
            Nova Mensagem
        </MudButton>
    </div>

    <!-- Search and Filters Section -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid alignitems="Center">
            <MudItem xs="12" md="6">
                <MudTextField T="string"
                              id="messageSearch"
                              Label="Buscar mensagens..."
                              Value="@Filter.Search"
                              Immediate="true"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="Icons.Material.Filled.Search"/>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect T="long?"
                           @bind-Value="SelectedReceiverId"
                           Label="Filtrar por Contato"
                           Variant="Variant.Outlined"
                           Adornment="Adornment.Start"
                           AdornmentIcon="Icons.Material.Filled.Person"
                           Clearable="true"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var profile in _professionalProfiles)
                    {
                        <MudSelectItem T="long?"
                                       Value="@((long?)profile.UserId)">@profile.ProfessionalName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2" Class="d-flex justify-end">
                <MudChip T="string"
                         Text="@($"{PagedResult.TotalCount} mensagem{(PagedResult.TotalCount < 2 ? "" : "s")}")"
                         Color="Color.Info"
                         Size="Size.Medium"/>
            </MudItem>
        </MudGrid>

        @if (SelectedReceiverId.HasValue)
        {
            var selectedProfile = _professionalProfiles.FirstOrDefault(p => p.UserId == SelectedReceiverId.Value);
            @if (selectedProfile != null)
            {
                <div class="mt-3">
                    <MudChip T="string"
                             Text="@($"Conversando com: {selectedProfile.ProfessionalName}")"
                             Color="Color.Primary"
                             Size="Size.Medium"
                             Icon="Icons.Material.Filled.PersonPin"/>
                </div>
            }
        }
    </MudPaper>

    <AlertDefault
        ShowProfessionalNotFoundAlert="_showProfessionalNotFoundAlert"
        ShowCurrentUserNotFoundAlert="_showCurrentUserNotFoundAlert"
        NavigateToInstructions="UserContext.NavigateToInstructions"
        NavigateToLogin="UserContext.NavigateToLogin"/>

    @if (_showContent)
    {
        @if (_isLoading)
        {
            <!-- Loading State -->
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true"/>
            </div>
        }
        else if (PagedResult.Items.Any())
        {
            <!-- Messages Cards -->
            <MudGrid>
                @foreach (var message in PagedResult.Items)
                {
                    <MudItem xs="12">
                        <MudCard Class="@GetMessageCardClass(message)" Elevation="2">
                            <MudCardContent Class="pa-4">
                                <div class="d-flex justify-space-between align-start mb-3">
                                    <div class="d-flex align-center gap-3">
                                        <MudAvatar Color="@GetAvatarColor(message)" Size="Size.Medium">
                                            <MudIcon Icon="@GetMessageIcon(message)"/>
                                        </MudAvatar>
                                        <div>
                                            <MudText Typo="Typo.subtitle1" Class="mb-1">
                                                @message.ReceiverProfessionalName
                                            </MudText>
                                            <MudText Typo="Typo.caption" Class="text-secondary-theme">
                                                @UserTimeZoneService.ConvertToUserTimeZone(
                                                    message.SentAt).ToString("dd/MM/yyyy HH:mm")
                                            </MudText>
                                        </div>
                                    </div>

                                    <div class="d-flex align-center gap-2">
                                        <MudChip T="string"
                                                 Text="@($"#{message.Id}")"
                                                 Size="Size.Small"
                                                 Variant="Variant.Text"
                                                 Color="Color.Default"/>
                                        <MudChip T="string"
                                                 Text="@(message.IsRead ? "Lida" : "Não lida")"
                                                 Size="Size.Small"
                                                 Color="@(message.IsRead ? Color.Success : Color.Warning)"
                                                 Icon="@(message.IsRead ? Icons.Material.Filled.MarkEmailRead : Icons.Material.Filled.MarkEmailUnread)"/>
                                    </div>
                                </div>

                                <!-- Message Content -->
                                <MudText Typo="Typo.body1" Class="mb-3" Style="line-height: 1.6;">
                                    @(message.Content.Length > 150
                                        ? message.Content[..150] + "..."
                                        : message.Content)
                                </MudText>

                                <!-- Action Buttons -->
                                <div class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               StartIcon="@(message.IsRead ? Icons.Material.Filled.Reply : Icons.Material.Filled.MarkEmailRead)"
                                               OnClick="@(() => ReplyToMessage(message.Id))">
                                        @(message.IsRead ? "Responder" : "Ler")
                                    </MudButton>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            <!-- Pagination -->
            <div class="d-flex justify-center mt-6">
                <MudPagination Count="@TotalPages"
                               SelectedChanged="GoToPage"
                               Selected="Filter.PageNumber"
                               Color="Color.Primary"
                               Size="Size.Large"
                               ShowFirstButton="true"
                               ShowLastButton="true"/>
            </div>
        }
        else
        {
            <!-- Empty State -->
            <MudPaper Class="pa-8 text-center" Elevation="0">
                <MudIcon Icon="@GetEmptyStateIcon()"
                         Size="Size.Large"
                         Color="Color.Secondary"
                         Class="mb-4"/>
                <MudText Typo="Typo.h6" Class="mb-2">
                    @GetEmptyStateTitle()
                </MudText>
                <MudText Typo="Typo.body1" Class="mb-4 text-secondary-theme">
                    @GetEmptyStateMessage()
                </MudText>
                @if (!SelectedReceiverId.HasValue && string.IsNullOrWhiteSpace(Filter.Search))
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="Icons.Material.Filled.Add"
                               OnClick="@CreateEntity">
                        Enviar Primeira Mensagem
                    </MudButton>
                }
                else if (SelectedReceiverId.HasValue)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="Icons.Material.Filled.Clear"
                               OnClick="@(() => SelectedReceiverId = null)">
                        Limpar Filtro
                    </MudButton>
                }
            </MudPaper>
        }
    }
</MudContainer>

@code {
    private long _userId;
    //private long _professionalId;
    private bool _showContent;
    private bool _showProfessionalNotFoundAlert;
    private bool _showCurrentUserNotFoundAlert;

    private IEnumerable<ProfessionalProfileDto> _professionalProfiles = [];
    private long? _selectedReceiverIdBacking;

    private long? SelectedReceiverId
    {
        get => _selectedReceiverIdBacking;
        set
        {
            if (_selectedReceiverIdBacking == value) return;
            _selectedReceiverIdBacking = value;
            _ = OnReceiverChangedAsync();
        }
    }

    private const string Title = "Minhas Mensagens";

    private FilterParams Filter { get; set; } = new() { PageSize = ConfigurationServer.PageSize, PageNumber = 1 };
    private PaginatedResult<MessageDto> PagedResult { get; set; } = new();
    private int TotalPages => (int)Math.Ceiling((double)(PagedResult.TotalCount) / Filter.PageSize);
    private bool _isLoading = true;

    private DotNetObjectReference<List>? _dotNetRef;
    private bool _disposed;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DefaultInitializationAsync();
            await FetchProfessionalProfiles();
            await LoadDataAsync();

            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await Js.InvokeVoidAsync("debounceInput", _dotNetRef, "messageSearch", ConfigurationServer.DebounceDelay);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al inicializar debounce: {ex.Message}");
            }

            StateHasChanged();
        }
    }

    private async Task DefaultInitializationAsync()
    {
        var context = await UserContext.InitializeUserContextAsync();
        _userId = context.UserId;
        //_professionalId = context.ProfessionalId;
        _showCurrentUserNotFoundAlert = context.ShowCurrentUserNotFoundAlert;
        _showProfessionalNotFoundAlert = context.ShowProfessionalNotFoundAlert;
        _showContent = context.ShowContent;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            if (SelectedReceiverId.HasValue)
            {
                PagedResult = await MessageService.GetPagedAsync(Filter, _userId, SelectedReceiverId);
            }
            else
            {
                PagedResult = new PaginatedResult<MessageDto> { Items = [] };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entities: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task FetchProfessionalProfiles()
    {
        try
        {
            _professionalProfiles = await ProfessionalProfileService.GetProfilesWithMessagesAsync(_userId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching professional profiles: {ex.Message}");
        }
    }

    [JSInvokable("OnDebouncedInput")]
    public async Task OnDebouncedInput(string searchText)
    {
        if (_disposed) return;
        Filter.Search = searchText;
        Filter.PageNumber = 1;

        await LoadDataAsync();
        StateHasChanged();
    }

    public void Dispose()
    {
        _disposed = true;
        _dotNetRef?.Dispose();
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > TotalPages || page == Filter.PageNumber) return;
        Filter.PageNumber = page;
        await LoadDataAsync();
    }

    private async Task OnReceiverChangedAsync()
    {
        Filter.PageNumber = 1;
        await LoadDataAsync();
        await InvokeAsync(StateHasChanged);
    }

    private void ReplyToMessage(long entityId)
    {
        NavigationManager.NavigateTo($"{AppRoutes.MessagesAnswer.Replace("{id}", entityId.ToString())}");
    }

    private void CreateEntity()
    {
        NavigationManager.NavigateTo($"{AppRoutes.MessagesCreate}");
    }

    // Helper methods for styling
    private string GetMessageCardClass(MessageDto message)
    {
        return message.IsRead ? "" : "mud-elevation-4";
    }

    private Color GetAvatarColor(MessageDto message)
    {
        return message.IsRead ? Color.Primary : Color.Warning;
    }

    private string GetMessageIcon(MessageDto message)
    {
        return message.IsRead ? Icons.Material.Filled.Message : Icons.Material.Filled.MarkEmailUnread;
    }

    private string GetEmptyStateIcon()
    {
        if (!SelectedReceiverId.HasValue)
            return Icons.Material.Outlined.Message;
        return Icons.Material.Outlined.SearchOff;
    }

    private string GetEmptyStateTitle()
    {
        if (!SelectedReceiverId.HasValue)
            return "Selecione um contato para visualizar as mensagens";
        if (!string.IsNullOrWhiteSpace(Filter.Search))
            return "Nenhuma mensagem encontrada";
        return "Nenhuma conversa com este contato";
    }

    private string GetEmptyStateMessage()
    {
        if (!SelectedReceiverId.HasValue)
            return "Use o filtro acima para selecionar um profissional e visualizar suas conversas.";
        if (!string.IsNullOrWhiteSpace(Filter.Search))
            return "Tente ajustar os termos de busca.";
        return "Comece uma conversa enviando uma mensagem para este profissional.";
    }

}