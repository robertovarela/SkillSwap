@page "/ProfessionalProfiles/Edit/{Id:long}"

@rendermode InteractiveServer
@attribute [Authorize]

@using Blazored.FluentValidation
@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Dtos.ProfessionalProfile
@using RDS.Core.Libraries.Services
@using RDS.Core.Models

@inject IUserContextService UserContext
@inject IProfessionalProfileService Service
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<title>@Title</title>

<MudContainer Class="mt-4" MaxWidth="MaxWidth.Medium">
    <!-- Header Section -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
            <MudText Typo="Typo.body1" Class="text-secondary-theme">
                Atualize as informações do seu perfil profissional
            </MudText>
        </div>
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   Size="Size.Large"
                   StartIcon="Icons.Material.Filled.ArrowBack"
                   OnClick="@NavigateBack">
            Voltar
        </MudButton>
    </div>

    <AlertDefault
        ShowProfessionalNotFoundAlert="_showProfessionalNotFoundAlert"
        ShowCurrentUserNotFoundAlert="_showCurrentUserNotFoundAlert"
        NavigateToInstructions="UserContext.NavigateToInstructions"
        NavigateToLogin="UserContext.NavigateToLogin"
    />

    @if (_isLoading)
    {
        <div class="d-flex justify-center pa-8">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true"/>
        </div>
    }
    else if (_showContent)
    {
        <!-- Form Card -->
        <MudPaper Class="pa-6" Elevation="3">
            <EditForm Model="@_entity" OnValidSubmit="HandleValidSubmit" Context="editContext">
                <FluentValidationValidator/>

                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="Icons.Material.Filled.Person" Class="mr-2"/>
                    Informações Pessoais
                </MudText>

                <MudGrid>
                    <!-- ProfessionalName Field -->
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string"
                                      @bind-Value="_entity.ProfessionalName"
                                      Label="Nome Profissional"
                                      Placeholder="Como você quer ser chamado(a)"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Seu nome profissional é obrigatório."
                                      MaxLength="100"
                                      Counter="100"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="Icons.Material.Filled.Badge"/>
                        <ValidationMessage For="@(() => _entity.ProfessionalName)"/>
                    </MudItem>

                    <!-- CPF Field -->
                    <MudItem xs="12" sm="6">
                        <div @ref="_cpfFieldContainer">
                            <MudTextField T="string"
                                          @bind-Value="_entity.Cpf"
                                          Label="CPF"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="O CPF é obrigatório."
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="Icons.Material.Filled.Fingerprint"/>
                        </div>
                        <ValidationMessage For="@(() => _entity.Cpf)"/>
                    </MudItem>
                    
                    <!-- BirthDate Field -->
                    <MudItem xs="12" sm="6" Class="mt-4">
                        <MudDatePicker @bind-Date="_birthDate"
                                       Label="Data de Nascimento"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="A data de nascimento é obrigatória."
                                       Editable="true"
                                       DateFormat="dd/MM/yyyy"
                                       icon="@Icons.Material.Filled.Cake"
                                       Adornment="Adornment.End"
                                       MaxDate="@_maxBirthDate" />
                        <ValidationMessage For="@(() => _entity.BirthDate)"/>
                    </MudItem>
                </MudGrid>
                
                <MudDivider Class="my-6"/>

                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="Icons.Material.Filled.School" Class="mr-2"/>
                    Informações Acadêmicas
                </MudText>
                
                <MudGrid>
                    <!-- TeachingInstitution Field -->
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string"
                                      @bind-Value="_entity.TeachingInstitution"
                                      Label="Instituição de Ensino"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="A instituição de ensino é obrigatória."
                                      MaxLength="100"
                                      Counter="100"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="Icons.Material.Filled.School"/>
                        <ValidationMessage For="@(() => _entity.TeachingInstitution)"/>
                    </MudItem>
                    
                    <!-- AcademicRegistry Field -->
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string"
                                      @bind-Value="_entity.AcademicRegistry"
                                      Label="Registro Acadêmico (RA)"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="O registro acadêmico é obrigatório."
                                      MaxLength="15"
                                      Counter="15"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="Icons.Material.Filled.ConfirmationNumber"/>
                        <ValidationMessage For="@(() => _entity.AcademicRegistry)"/>
                    </MudItem>
                </MudGrid>
                
                <MudDivider Class="my-6"/>
                
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="Icons.Material.Filled.Work" Class="mr-2"/>
                    Informações Profissionais
                </MudText>

                <MudGrid>
                    <!-- Bio Field -->
                    <MudItem xs="12">
                        <MudTextField T="string"
                                      @bind-Value="_entity.Bio"
                                      Label="Biografia"
                                      Placeholder="Fale um pouco sobre você, sua carreira e seus interesses..."
                                      Variant="Variant.Outlined"
                                      Lines="4"
                                      MaxLength="500"
                                      Counter="500"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="Icons.Material.Filled.Description"
                                      HelperText="Uma boa biografia ajuda a criar conexões."/>
                        <ValidationMessage For="@(() => _entity.Bio)"/>
                    </MudItem>

                    <!-- Expertise Field -->
                    <MudItem xs="12" Class="mt-4">
                        <MudTextField T="string"
                                      @bind-Value="_entity.Expertise"
                                      Label="Especialidades"
                                      Placeholder="Ex: Desenvolvimento Web, Design Gráfico, Marketing Digital..."
                                      Variant="Variant.Outlined"
                                      MaxLength="200"
                                      Counter="200"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="Icons.Material.Filled.Star"
                                      HelperText="Liste suas principais áreas de conhecimento."/>
                        <ValidationMessage For="@(() => _entity.Expertise)"/>
                    </MudItem>
                </MudGrid>

                <!-- Action Buttons -->
                <div class="d-flex justify-space-between align-center mt-8">
                    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@NavigateBack" Size="Size.Large" StartIcon="Icons.Material.Filled.Cancel">Cancelar</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit" Size="Size.Large" StartIcon="Icons.Material.Filled.Save" Disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                            <span>Salvando...</span>
                        }
                        else
                        {
                            <span>Salvar Alterações</span>
                        }
                    </MudButton>
                </div>
            </EditForm>
        </MudPaper>
    }
</MudContainer>

@code {
    private long _userId;
    private bool _showContent;
    private bool _showProfessionalNotFoundAlert;
    private bool _showCurrentUserNotFoundAlert;
    private bool _isLoading = true;
    private bool _isSubmitting;
    private ElementReference _cpfFieldContainer;

    [Parameter] public long Id { get; set; }

    private ProfessionalProfileUpdateDto _entity = new();
    private const string Title = "Editar Perfil Profissional";
    private DateTime? _maxBirthDate;
    
    private DateTime? _birthDate
    {
        // ReSharper disable once UnusedMember.Local
        get => _entity.BirthDate.ToDateTime(TimeOnly.MinValue);
        set => _entity.BirthDate = value.HasValue ? DateOnly.FromDateTime(value.Value) : default;
    }

    protected override async Task OnInitializedAsync()
    {
        _maxBirthDate = DateTime.Today.AddYears(-18);
        await DefaultInitializationAsync();
        VerifyProfileId(Id, _userId);
        await LoadDataAsync();
        _isLoading = false;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _showContent)
        {
            try
            {
                await Task.Delay(50);
                await JSRuntime.InvokeVoidAsync("applyCpfMask", _cpfFieldContainer);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error applying CPF mask: {ex.Message}");
            }
        }
    }

    private async Task DefaultInitializationAsync()
    {
        var context = await UserContext.InitializeUserContextAsync();
        _userId = context.UserId;
        _showCurrentUserNotFoundAlert = context.ShowCurrentUserNotFoundAlert;
        _showProfessionalNotFoundAlert = context.ShowProfessionalNotFoundAlert;
        _showContent = context.ShowContent;
    }

    private void VerifyProfileId(long id, long userId)
    {
        if (id == userId) return;
        _showProfessionalNotFoundAlert = true;
        _showContent = false;
    }

    private async Task LoadDataAsync()
    {
        if (!_showContent) return;

        var result = await Service.GetForEditingAsync(Id);
        if (result == null)
        {
            _showContent = false;
            _showProfessionalNotFoundAlert = true;
            return;
        }

        _entity = result;
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            _isSubmitting = true;
            await Service.UpdateAsync(_entity);
            await UserContext.InitializeUserContextAsync();
            Snackbar.Add("Perfil atualizado com sucesso!", Severity.Success);
            NavigateBack();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao atualizar perfil: {ex.Message}");
            Snackbar.Add("Ocorreu um erro ao atualizar seu perfil.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"{AppRoutes.ProfesionalProfiles}");
    }

}
