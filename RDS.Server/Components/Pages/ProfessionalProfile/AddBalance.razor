@page "/ProfessionalProfiles/AddBalance"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using RDS.Core.Libraries.Services
@using RDS.Core.Utils

@inject IUserContextService UserContext
@inject IProfessionalProfileService ProfileService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject CultureHelper CultureHelper

<title>@Title</title>

<MudContainer Class="mt-4" MaxWidth="MaxWidth.Medium">
    <!-- Header Section -->
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="mb-2">@Title</MudText>
            <MudText Typo="Typo.body1" Class="text-secondary-theme">
                Adicione SkillDólares (SD$) ao seu saldo
            </MudText>
        </div>
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   Size="Size.Large"
                   StartIcon="Icons.Material.Filled.ArrowBack"
                   OnClick="@NavigateBack">
            Voltar
        </MudButton>
    </div>

    <AlertDefault
        ShowProfessionalNotFoundAlert="_showProfessionalNotFoundAlert"
        ShowCurrentUserNotFoundAlert="_showCurrentUserNotFoundAlert"
        NavigateToInstructions="UserContext.NavigateToInstructions"
        NavigateToLogin="UserContext.NavigateToLogin"
    />

    @if (_showContent)
    {
        <MudPaper Class="pa-6" Elevation="3">
            <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="Icons.Material.Filled.MonetizationOn" Class="mr-2"/>
                    Adicionar Saldo
                </MudText>

                <MudGrid>
                    <MudItem xs="12">
                        <MudNumericField @bind-Value="_model.Amount"
                                         Label="Valor a Adicionar"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         RequiredError="O valor é obrigatório."
                                         Min="1"
                                         Format="C2"
                                         Culture="@CultureHelper.SkillDollarCulture"
                                         HelperText="O valor será adicionado ao seu saldo em SkillDólares (SD$)"
                                         Adornment="Adornment.Start"
                                         AdornmentText="SD$"/>
                        <ValidationMessage For="@(() => _model.Amount)"/>
                    </MudItem>
                </MudGrid>

                <div class="d-flex justify-end align-center mt-8">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               ButtonType="ButtonType.Submit"
                               Size="Size.Large"
                               StartIcon="Icons.Material.Filled.AddCard"
                               Disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true"/>
                            <span>Adicionando...</span>
                        }
                        else
                        {
                            <span>Confirmar Adição</span>
                        }
                    </MudButton>
                </div>
            </EditForm>
        </MudPaper>
    }
</MudContainer>

@code {
    private long _professionalId;
    private bool _showContent;
    private bool _showProfessionalNotFoundAlert;
    private bool _showCurrentUserNotFoundAlert;
    private bool _isSubmitting;

    private const string Title = "Adicionar Saldo";
    private readonly AddBalanceModel _model = new();

    public class AddBalanceModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "O valor é obrigatório.")]
        [System.ComponentModel.DataAnnotations.Range(1, double.MaxValue, ErrorMessage = "O valor deve ser positivo.")]
        public decimal? Amount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await DefaultInitializationAsync();
    }

    private async Task DefaultInitializationAsync()
    {
        var context = await UserContext.InitializeUserContextAsync();
        _professionalId = context.ProfessionalId;
        _showCurrentUserNotFoundAlert = context.ShowCurrentUserNotFoundAlert;
        _showProfessionalNotFoundAlert = context.ShowProfessionalNotFoundAlert;
        _showContent = context.ShowContent;
    }

    private async Task HandleValidSubmit()
    {
        if (_model.Amount is null) return;

        try
        {
            _isSubmitting = true;
            await ProfileService.AddBalanceAsync(_professionalId, _model.Amount.Value);
            Snackbar.Add("Saldo adicionado com sucesso!", Severity.Success);
            NavigateBack();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao adicionar saldo: {ex.Message}");
            Snackbar.Add("Ocorreu um erro ao adicionar saldo.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateBack()
        => NavigationManager.NavigateTo(AppRoutes.ProfesionalProfiles);
}
