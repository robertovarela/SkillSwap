@page "/Account/Manage/ChangePassword"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using RDS.Core.Models
@layout AccountLayout

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger

<PageTitle>Alterar senha</PageTitle>

<MudText Typo="Typo.h5" Align="Align.Center" GutterBottom="true">Alterar Senha</MudText>

@if (_errorMessages.Any())
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @foreach (var error in _errorMessages)
        {
            <MudText>@error</MudText>
        }
    </MudAlert>
}

<div class="mt-4">
    <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" role="alert" />

        <MudStack Spacing="3">
            <MudStaticTextField For="@(() => Input.OldPassword)"
                                @bind-Value="Input.OldPassword"
                                Label="Senha Atual"
                                Variant="Variant.Outlined"
                                InputType="InputType.Password"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Lock" />

            <MudStaticTextField For="@(() => Input.NewPassword)"
                                @bind-Value="Input.NewPassword"
                                Label="Nova Senha"
                                Variant="Variant.Outlined"
                                InputType="InputType.Password"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Password" />

            <MudStaticTextField For="@(() => Input.ConfirmPassword)"
                                @bind-Value="Input.ConfirmPassword"
                                Label="Confirmar Nova Senha"
                                Variant="Variant.Outlined"
                                InputType="InputType.Password"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Password" />

            <MudStaticButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" FormAction="FormAction.Submit">Alterar Senha</MudStaticButton>
        </MudStack>
    </EditForm>
</div>

<MudDivider Class="my-4"/>

<MudButton Variant="Variant.Text"
           Color="Color.Default"
           StartIcon="@Icons.Material.Filled.ArrowBack"
           Href="/Account/Manage"
           FullWidth="true">
    Voltar ao Perfil
</MudButton>

@code {
    //private string? _message;
    private ApplicationUser _user = default!;
    private List<string> _errorMessages = [];
    private bool _hasPassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _hasPassword = await UserManager.HasPasswordAsync(_user);
        if (!_hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/SetPassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        _errorMessages.Clear();
        var changePasswordResult = await UserManager.ChangePasswordAsync(_user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            _errorMessages = changePasswordResult.Errors.Select(error => error.Description).ToList();
            return;
        }

        await SignInManager.RefreshSignInAsync(_user);
        Logger.LogInformation("User changed their password successfully.");

        RedirectManager.RedirectToCurrentPageWithStatus("Sua senha foi alterada", HttpContext);
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "A senha atual é obrigatória.")]
        [DataType(DataType.Password)]
        [Display(Name = "Senha atual")]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "A nova senha é obrigatória.")]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} e no máximo {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Nova senha")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirmar nova senha")]
        [Compare("NewPassword", ErrorMessage = "A nova senha e a confirmação não correspondem.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
