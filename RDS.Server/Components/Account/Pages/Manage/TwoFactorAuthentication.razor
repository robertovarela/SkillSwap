@page "/Account/Manage/TwoFactorAuthentication"
@layout AccountLayout

@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using RDS.Core.Models

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>Autenticação de Dois Fatores (2FA)</PageTitle>

<MudText Typo="Typo.h5" Align="Align.Center" GutterBottom="true">Autenticação de Dois Fatores (2FA)</MudText>

<StatusMessage />

@if (_canTrack)
{
    <div class="mt-4">
        @if (_is2FaEnabled)
        {
            if (_recoveryCodesLeft == 0)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    <strong>Você não tem mais códigos de recuperação.</strong>
                    <br />
                    Você deve <MudLink Href="Account/Manage/GenerateRecoveryCodes">gerar um novo conjunto de códigos</MudLink> antes de poder fazer login com um código de recuperação.
                </MudAlert>
            }
            else if (_recoveryCodesLeft == 1)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    <strong>Você tem 1 código de recuperação restante.</strong>
                    <br />
                    Você pode <MudLink Href="Account/Manage/GenerateRecoveryCodes">gerar um novo conjunto de códigos de recuperação</MudLink>.
                </MudAlert>
            }
            else if (_recoveryCodesLeft <= 3)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    <strong>Você tem @_recoveryCodesLeft códigos de recuperação restantes.</strong>
                    <br />
                    Você deveria <MudLink Href="Account/Manage/GenerateRecoveryCodes">gerar um novo conjunto de códigos de recuperação</MudLink>.
                </MudAlert>
            }

            if (_isMachineRemembered)
            {
                <form style="display: inline-block" @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post">
                    <AntiforgeryToken />
                    <MudStaticButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Info" Class="mb-2">Esquecer este navegador</MudStaticButton>
                </form>
            }

            <MudButton Href="Account/Manage/Disable2fa" Variant="Variant.Filled" Color="Color.Error" Class="mb-2">Desabilitar 2FA</MudButton>
            <MudButton Href="Account/Manage/GenerateRecoveryCodes" Variant="Variant.Filled" Color="Color.Secondary" Class="mb-2">Redefinir códigos de recuperação</MudButton>
        }

        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">App Autenticador</MudText>
            @if (!_hasAuthenticator)
            {
                <MudButton Href="Account/Manage/EnableAuthenticator" Variant="Variant.Filled" Color="Color.Success">Adicionar app autenticador</MudButton>
            }
            else
            {
                <MudButton Href="Account/Manage/EnableAuthenticator" Variant="Variant.Filled" Color="Color.Primary" Class="mb-2">Configurar app autenticador</MudButton>
                <MudButton Href="Account/Manage/ResetAuthenticator" Variant="Variant.Filled" Color="Color.Warning" Class="mb-2">Redefinir app autenticador</MudButton>
            }
        </MudPaper>
    </div>
}
else
{
    <MudAlert Severity="Severity.Error" Class="mt-4">
        <strong>A política de privacidade e cookies não foi aceita.</strong>
        <br />
        Você precisa aceitar a política antes de habilitar a autenticação de dois fatores.
    </MudAlert>
}

<MudDivider Class="my-4" />

<MudButton Variant="Variant.Text"
           Color="Color.Default"
           StartIcon="@Icons.Material.Filled.ArrowBack"
           Href="/Account/Manage"
           FullWidth="true">
    Voltar ao Perfil
</MudButton>

@code {
    private bool _canTrack;
    private bool _hasAuthenticator;
    private int _recoveryCodesLeft;
    private bool _is2FaEnabled;
    private bool _isMachineRemembered;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        _hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        _is2FaEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        _isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        _recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        RedirectManager.RedirectToCurrentPageWithStatus(
            "O navegador atual foi esquecido. Quando você fizer login novamente neste navegador, será solicitado seu código 2FA.",
            HttpContext);
    }

}
